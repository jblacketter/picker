{% extends 'base.html' %}
{% load static %}

{% block title %}{{ session.title }} - Picker{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Progress Indicator -->
    <div class="mb-8">
        <div class="flex items-center justify-between text-sm">
            <span class="text-gray-600">Step 1: Question</span>
            <span class="text-gray-600">Step 2: Context</span>
            <span class="text-blue-600 font-semibold">Step 3: Research</span>
        </div>
        <div class="mt-2 h-2 bg-gray-200 rounded-full">
            <div class="h-2 bg-blue-600 rounded-full" style="width: 100%"></div>
        </div>
    </div>

    <!-- Session Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">{{ session.title }}</h1>
                <p class="text-sm text-gray-500 mt-1">{{ session.created_at|date:"F d, Y at g:i A" }}</p>
            </div>
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                ✓ Completed
            </span>
        </div>

        <div class="border-t border-gray-200 pt-4">
            <h3 class="text-sm font-medium text-gray-700 mb-2">Original Question:</h3>
            <p class="text-gray-900">{{ session.original_question }}</p>
        </div>
    </div>

    <!-- Summary -->
    <div class="bg-blue-50 border-l-4 border-blue-600 rounded-r-lg p-6 mb-6">
        <h2 class="text-lg font-semibold text-blue-900 mb-2">Summary</h2>
        <p class="text-gray-800">{{ response.summary }}</p>
    </div>

    <!-- Detailed Analysis -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Analysis</h2>
        <div class="prose max-w-none markdown-content">
            {{ response.detailed_response|safe }}
        </div>
    </div>

    <!-- Resources -->
    {% if response.links %}
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Resources for Further Research</h2>
        <div class="space-y-4">
            {% for link in response.links %}
            <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition">
                <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="block">
                    <h3 class="font-semibold text-blue-600 hover:text-blue-700 mb-1">
                        {{ link.title }} ↗
                    </h3>
                    <p class="text-sm text-gray-600">{{ link.description }}</p>
                    <p class="text-xs text-gray-400 mt-2">{{ link.url }}</p>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Your Context -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Your Context</h2>
        <div class="space-y-3">
            {% for clarification in session.clarifications.all %}
                {% if clarification.user_response %}
                <div class="border-l-2 border-gray-300 pl-4">
                    <p class="text-sm font-medium text-gray-700">{{ clarification.question_text }}</p>
                    <p class="text-gray-900 mt-1">{{ clarification.user_response.response_text }}</p>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Notes Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Personal Notes</h2>

        <!-- Add Note Form -->
        <form method="post" action="{% url 'research:add_note' session.id %}" class="mb-6">
            {% csrf_token %}
            <textarea
                name="note_text"
                rows="3"
                placeholder="Add your thoughts, decisions, or follow-up questions..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
            ></textarea>
            <button
                type="submit"
                class="mt-2 bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200"
            >
                Add Note
            </button>
        </form>

        <!-- Existing Notes -->
        {% if session.notes.all %}
        <div class="space-y-3">
            {% for note in session.notes.all %}
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                <p class="text-gray-900">{{ note.note_text }}</p>
                <p class="text-xs text-gray-500 mt-2">{{ note.created_at|date:"M d, Y g:i A" }}</p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-500 text-sm italic">No notes yet. Add your thoughts above.</p>
        {% endif %}
    </div>

    <!-- Actions -->
    <div class="mt-6 flex space-x-4">
        <a
            href="{% url 'research:home' %}"
            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg text-center transition duration-200"
        >
            Ask Another Question
        </a>
        <a
            href="{% url 'research:session_list' %}"
            class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-200"
        >
            View All Research
        </a>
    </div>
</div>
{% endblock %}
